#!/bin/zsh
# Restic forget/prune - Apply GFS retention
set -euo pipefail

# Load logdy function
source "$HOME/.zprezto/custom/functions/logdy"

export LOGDY_ALSO_TO_FILE="{{ restic.logs.forget }}"
LOG_FILE="{{ restic.logs.forget }}"

logdy info "Starting restic forget/prune" retention_policy="GFS"

apply_retention() {
    local env_file="$1"
    local tag="$2"

    # Load environment from config file
    if [ ! -f "$env_file" ]; then
        logdy error "Environment file not found" path="$env_file"
        return 1
    fi

    source "$env_file"

    logdy info "Processing repository" tag="$tag" repository="$RESTIC_REPOSITORY"

    if restic forget \
        --tag "$tag" \
        --keep-hourly {{ restic.retention.hourly }} \
        --keep-daily {{ restic.retention.daily }} \
        --keep-monthly {{ restic.retention.monthly }} \
        --prune \
        --verbose >> "$LOG_FILE" 2>&1; then
        logdy info "Retention applied successfully" tag="$tag"
    else
        logdy error "Failed to apply retention" tag="$tag"
        return 1
    fi
}

FAILED=0
apply_retention "/etc/restic/env.home" "home" || FAILED=1
apply_retention "/etc/restic/env.root" "root" || FAILED=1

if [ $FAILED -eq 0 ]; then
    logdy info "All repositories processed successfully"
    exit 0
else
    logdy error "Some repositories failed retention policy"
    exit 1
fi
