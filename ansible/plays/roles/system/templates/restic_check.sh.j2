#!/bin/zsh
# Restic repository integrity check
set -euo pipefail

# Load logdy function
source "$HOME/.zprezto/custom/functions/logdy"

export LOGDY_ALSO_TO_FILE="{{ restic.logs.check }}"
LOG_FILE="{{ restic.logs.check }}"

# SFTP settings for Hetzner Storage Box (SSH key authentication)
export RESTIC_SFTP_COMMAND="sftp -i {{ restic.sftp.ssh_key_path }} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"

logdy info "Starting restic repository check"

check_repo() {
    local repo="$1"
    local password="$2"
    local name="$3"

    export RESTIC_REPOSITORY="$repo"
    export RESTIC_PASSWORD="$password"

    logdy info "Checking repository" tag="$name"

    if restic check --read-data-subset=5% >> "$LOG_FILE" 2>&1; then
        logdy info "Repository check passed" tag="$name"
    else
        logdy error "Repository check failed" tag="$name"
        return 1
    fi
}

FAILED=0
check_repo "{{ restic.home.repository }}" "{{ restic.home.password }}" "home" || FAILED=1
check_repo "{{ restic.root.repository }}" "{{ restic.root.password }}" "root" || FAILED=1

if [ $FAILED -eq 0 ]; then
    logdy info "All repository checks passed"
    exit 0
else
    logdy error "Some repository checks failed"
    exit 1
fi
