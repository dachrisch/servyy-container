#!/bin/zsh
# Restic repository integrity check
set -euo pipefail

# Load logdy function
source "$HOME/.zprezto/custom/functions/logdy"

export LOGDY_ALSO_TO_FILE="{{ restic.logs.check }}"
LOG_FILE="{{ restic.logs.check }}"

logdy info "Starting restic repository check"

check_repo() {
    local env_file="$1"
    local name="$2"

    # Load environment from config file
    if [ ! -f "$env_file" ]; then
        logdy error "Environment file not found" path="$env_file"
        return 1
    fi

    source "$env_file"

    logdy info "Checking repository" tag="$name" repository="$RESTIC_REPOSITORY"

    if restic check --read-data-subset=5% >> "$LOG_FILE" 2>&1; then
        logdy info "Repository check passed" tag="$name"
    else
        logdy error "Repository check failed" tag="$name"
        return 1
    fi
}

FAILED=0
check_repo "/etc/restic/env.home" "home" || FAILED=1
check_repo "/etc/restic/env.root" "root" || FAILED=1

if [ $FAILED -eq 0 ]; then
    logdy info "All repository checks passed"
    exit 0
else
    logdy error "Some repository checks failed"
    exit 1
fi
