#!/bin/bash
set -e

# Set COMPOSE_PROJECT_NAME for services that use it in container_name
export COMPOSE_PROJECT_NAME="{{ dir_name }}"

{% for service in (lookup('file', (docker.local_dir, dir_name, 'docker-compose.yml') | path_join ) | from_yaml)['services'] | dict2items %}
{% set service_name = service.key %}
{% set container_name_raw = service.value.container_name | default(dir_name + '.' + service_name) %}
{% set container_name = container_name_raw | replace('${COMPOSE_PROJECT_NAME}', dir_name) %}
# Use command substitution instead of pipe to avoid zombie processes
container_state=$(docker container inspect {{ container_name }} --format={% raw %}'{{.State.Running}}'{% endraw %} 2>/dev/null || echo "false")
if [[ "$container_state" == "true" ]]; then
    echo "Container {{ container_name }} is up and running"
else
    echo "Container {{ container_name }} is not running"
    exit 3
fi
{% endfor %}
