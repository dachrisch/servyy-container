{% raw %}
#!/bin/bash
# Dynamic blocklist update script - queries Loki for top offenders
# Managed by Ansible - do not edit manually

set -euo pipefail

# Configuration
# Loki is accessible via Traefik at /loki path or directly via Docker network
# Get the first IP from any network the container is on
LOKI_DOCKER_IP=$(docker inspect -f '{{(index .NetworkSettings.Networks "proxy").IPAddress}}' monitor.loki 2>/dev/null || echo "")
if [[ -n "$LOKI_DOCKER_IP" ]]; then
    LOKI_URL="http://${LOKI_DOCKER_IP}:3100"
else
    LOKI_URL="https://monitor.lehel.xyz/loki"
fi
LOKI_TENANT_ID="servyy-logs-k8x9m2p4q7"
BLOCKLIST_LOG="/var/log/fail2ban-loki.log"
MIN_ATTEMPTS=10
TIME_RANGE="24h"

# Ensure log file exists
touch "$BLOCKLIST_LOG"

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') [blocklist] $*"
}

# Query Loki for top attacking IPs (SSH brute force)
get_ssh_attackers() {
    log "Querying Loki for SSH brute force attackers..."

    # Query for IPs with more than MIN_ATTEMPTS invalid user attempts
    local query='topk(50, sum by (ip) (count_over_time({job="auth"} |~ "Invalid user" | regexp "from (?P<ip>[0-9.]+) port"['"$TIME_RANGE"'])))'

    curl -s -H "X-Scope-OrgID: $LOKI_TENANT_ID" \
        "$LOKI_URL/loki/api/v1/query" \
        --data-urlencode "query=$query" 2>/dev/null | \
    jq -r '.data.result[] | select(.value[1] | tonumber >= '"$MIN_ATTEMPTS"') | .metric.ip + " ssh-brute-force attempts=" + .value[1]' 2>/dev/null || true
}

# Query Loki for scanner/bot IPs
get_scanner_ips() {
    log "Querying Loki for scanner/bot IPs..."

    # Query for IPs using known scanner user agents
    local query='topk(50, sum by (ip) (count_over_time({job="docker"} |~ "(?i)(nikto|sqlmap|nmap|masscan|zgrab|nuclei|dirbuster)" | regexp "(?P<ip>[0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+)"['"$TIME_RANGE"'])))'

    curl -s -H "X-Scope-OrgID: $LOKI_TENANT_ID" \
        "$LOKI_URL/loki/api/v1/query" \
        --data-urlencode "query=$query" 2>/dev/null | \
    jq -r '.data.result[] | select(.value[1] | tonumber >= 1) | .metric.ip + " scanner-bot attempts=" + .value[1]' 2>/dev/null || true
}

# Query for IPs with excessive 4xx errors
get_error_ips() {
    log "Querying Loki for IPs with excessive errors..."

    local query='topk(50, sum by (ip) (count_over_time({job="docker"} |~ "\" 4[0-9][0-9] " | regexp "(?P<ip>[0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+)"['"$TIME_RANGE"'])))'

    curl -s -H "X-Scope-OrgID: $LOKI_TENANT_ID" \
        "$LOKI_URL/loki/api/v1/query" \
        --data-urlencode "query=$query" 2>/dev/null | \
    jq -r '.data.result[] | select(.value[1] | tonumber >= 100) | .metric.ip + " excessive-errors attempts=" + .value[1]' 2>/dev/null || true
}

# Get currently banned IPs to avoid duplicates
get_banned_ips() {
    fail2ban-client status loki-blocklist 2>/dev/null | grep "Banned IP" | sed 's/.*: //' | tr ' ' '\n' || true
}

# Main execution
main() {
    log "Starting blocklist update from Loki..."

    # Check if Loki is reachable
    if ! curl -s -H "X-Scope-OrgID: $LOKI_TENANT_ID" "$LOKI_URL/ready" >/dev/null 2>&1; then
        log "ERROR: Loki is not reachable at $LOKI_URL"
        exit 1
    fi

    # Get currently banned IPs
    local banned_ips
    banned_ips=$(get_banned_ips)

    # Collect all offending IPs
    local new_ips=()

    # SSH attackers
    while IFS= read -r line; do
        [[ -z "$line" ]] && continue
        local ip="${line%% *}"
        local reason="${line#* }"

        # Skip if already banned
        if echo "$banned_ips" | grep -q "^$ip$"; then
            continue
        fi

        # Skip private IPs
        if [[ "$ip" =~ ^(10\.|172\.(1[6-9]|2[0-9]|3[01])\.|192\.168\.|127\.) ]]; then
            continue
        fi

        # Add to blocklist log (fail2ban will pick it up)
        echo "$(date '+%Y-%m-%d %H:%M:%S') $ip $reason" >> "$BLOCKLIST_LOG"
        new_ips+=("$ip")
        log "Added $ip ($reason)"
    done < <(get_ssh_attackers)

    # Scanner IPs
    while IFS= read -r line; do
        [[ -z "$line" ]] && continue
        local ip="${line%% *}"
        local reason="${line#* }"

        if echo "$banned_ips" | grep -q "^$ip$"; then
            continue
        fi

        if [[ "$ip" =~ ^(10\.|172\.(1[6-9]|2[0-9]|3[01])\.|192\.168\.|127\.) ]]; then
            continue
        fi

        echo "$(date '+%Y-%m-%d %H:%M:%S') $ip $reason" >> "$BLOCKLIST_LOG"
        new_ips+=("$ip")
        log "Added $ip ($reason)"
    done < <(get_scanner_ips)

    # Excessive error IPs
    while IFS= read -r line; do
        [[ -z "$line" ]] && continue
        local ip="${line%% *}"
        local reason="${line#* }"

        if echo "$banned_ips" | grep -q "^$ip$"; then
            continue
        fi

        if [[ "$ip" =~ ^(10\.|172\.(1[6-9]|2[0-9]|3[01])\.|192\.168\.|127\.) ]]; then
            continue
        fi

        echo "$(date '+%Y-%m-%d %H:%M:%S') $ip $reason" >> "$BLOCKLIST_LOG"
        new_ips+=("$ip")
        log "Added $ip ($reason)"
    done < <(get_error_ips)

    log "Blocklist update complete. Added ${#new_ips[@]} new IPs."

    # Rotate log if too large (>10MB)
    local log_size
    log_size=$(stat -f%z "$BLOCKLIST_LOG" 2>/dev/null || stat -c%s "$BLOCKLIST_LOG" 2>/dev/null || echo 0)
    if [[ "$log_size" -gt 10485760 ]]; then
        log "Rotating blocklist log..."
        mv "$BLOCKLIST_LOG" "${BLOCKLIST_LOG}.old"
        touch "$BLOCKLIST_LOG"
    fi
}

main "$@"
{% endraw %}
