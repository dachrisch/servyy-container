# fail2ban jail configuration
# Managed by Ansible - do not edit manually

[DEFAULT]
# Ban duration: 1 hour by default
bantime = 3600

# Time window for counting failures
findtime = 600

# Number of failures before ban
maxretry = 5

# Ignore local IPs
ignoreip = 127.0.0.1/8 ::1 {{ ansible_facts['default_ipv4']['address'] | default('') }}

# Use iptables for banning
banaction = iptables-multiport

# Email notifications (optional)
# destemail = admin@{{ inventory_hostname }}
# sender = fail2ban@{{ inventory_hostname }}

# Action to take when banning
action = %(action_)s

#
# SSH Protection
#
[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = 86400
findtime = 3600

# Custom SSH filter for "Invalid user" attempts
[sshd-invalid-user]
enabled = true
port = ssh
filter = sshd-custom
logpath = /var/log/auth.log
maxretry = 2
bantime = 86400
findtime = 600

#
# Loki-sourced blocklist (populated by script)
# Traefik protection now handled via Loki queries (see update-from-loki.sh)
#
[loki-blocklist]
enabled = true
port = http,https,ssh
filter = loki-blocklist
# This jail uses IPs from Loki queries
# Managed by /usr/local/bin/blocklist/update-from-loki.sh
# IMPORTANT: Must use polling backend to read from log file instead of journal
backend = polling
banaction = iptables-allports
logpath = /var/log/fail2ban-loki.log
maxretry = 1
bantime = 86400
findtime = 86400
