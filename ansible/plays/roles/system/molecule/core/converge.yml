---
- name: Converge (Core)
  hosts: all
  become: true
  vars:
    # Override vars that require real infrastructure
    create_user: testuser
    has_10g_volume: false
    create_swap: false
    with_fail2ban: false
    with_containers: false
    copy_local_key: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAQC... testkey"
    sys_packages:
      - jq
      - curl
      - vim
      - git
      - monit
      - tzdata
    docker_cleanup:
      enabled: false
    kernel_cleanup:
      enabled: false
    storagebox_credentials:
      host: "mock.example.com"
      share: "backup"
      user: "mockuser"
      pass: "mockpass"
    monit:
      email: "test@example.com"
      smtp:
        host: "smtp.example.com"
        port: 587
        account: "testuser"
        password: "testpass"
    restic:
      logs:
        backup_home: "/var/log/restic-backup-home.log"
        backup_root: "/var/log/restic-backup-root.log"
        forget: "/var/log/restic-forget.log"
        check: "/var/log/restic-check.log"
    storagebox:
      mount: "/mnt/storagebox"
  tasks:
    # Core system configuration tasks (no Docker dependencies)

    - name: Run packages tasks  # noqa: role-name[path]
      ansible.builtin.include_role:
        name: "{{ playbook_dir }}/../../"
        tasks_from: packages
      tags: [system.packages]

    - name: Run user tasks  # noqa: role-name[path]
      ansible.builtin.include_role:
        name: "{{ playbook_dir }}/../../"
        tasks_from: user
      tags: [system.user]

    - name: Run journald tasks  # noqa: role-name[path]
      ansible.builtin.include_role:
        name: "{{ playbook_dir }}/../../"
        tasks_from: journald
      tags: [system.journald]

    - name: Run monit tasks  # noqa: role-name[path]
      ansible.builtin.include_role:
        name: "{{ playbook_dir }}/../../"
        tasks_from: monit
      tags: [system.monit]
      # - docker_cleanup: Disabled with docker_cleanup.enabled=false
      # - kernel_cleanup: Disabled with kernel_cleanup.enabled=false
      # - restic_maintenance: Requires restic repository setup
