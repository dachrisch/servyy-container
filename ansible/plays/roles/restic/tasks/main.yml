---
# Orchestrator for Restic role

- name: Sync Restic passwords to Vaultwarden
  delegate_to: localhost
  run_once: false
  become: false
  shell: "./scripts/add-restic-passwords-to-vaultwarden.sh {{ inventory_hostname }}"
  args:
    chdir: "{{ playbook_dir }}/../../"
  environment:
    BW_EMAIL: "{{ vaultwarden_email | default('') }}"
    BW_PASSWORD: "{{ vaultwarden_password | default('') }}"
  tags:
    - restic
    - restic.vaultwarden
  ignore_errors: yes

- name: Initialize Restic Infrastructure
  include_tasks: init.yml
  tags:
    - restic
    - restic.init

- name: Setup Test Environment
  include_tasks: test_setup.yml
  when: inventory_hostname == 'servyy-test.lxd'
  tags:
    - restic
    - restic.test

- name: Manual Lockout Recovery
  include_tasks: recreate.yml
  when: ansible_run_tags | intersect(['restic.recreate']) | length > 0
  tags:
    - restic.recreate

# ----------------------------------------------------------------------------
# INTEGRATED RESTORE (Critical for recovery)
# ----------------------------------------------------------------------------
# These tasks always run to ensure data is "re-hydrated" on fresh hosts.
# The decision matrix inside restore.yml ensures they SKIP on healthy hosts.

- name: Restore Gitea Data
  include_tasks: restore.yml
  vars:
    restore_path: "{{ (docker.remote_dir, 'git', 'repos') | path_join }}"
    backup_name: "{{ (inventory_hostname == 'servyy-test.lxd') | ternary('test', 'home') }}"
    owner: "root"
  when: with_containers | default(false)
  tags:
    - restic
    - restic.restore

- name: Restore PhotoPrism Database
  include_tasks: restore.yml
  vars:
    restore_path: "{{ (docker.remote_dir, 'photoprism', 'database') | path_join }}"
    backup_name: "{{ (inventory_hostname == 'servyy-test.lxd') | ternary('test', 'home') }}"
    owner: "{{ create_user }}"
  when: with_containers | default(false)
  tags:
    - restic
    - restic.restore

- name: Restore Vaultwarden Data
  include_tasks: restore.yml
  vars:
    restore_path: "{{ (docker.remote_dir, 'pass', 'vw-data') | path_join }}"
    backup_name: "{{ (inventory_hostname == 'servyy-test.lxd') | ternary('test', 'home') }}"
    owner: "root"
  when: with_containers | default(false)
  tags:
    - restic
    - restic.restore

# ----------------------------------------------------------------------------
# OPERATIONALIZE (Backup schedules)
# ----------------------------------------------------------------------------

- name: Deploy Backup Schedules and Timers
  include_tasks: backup.yml
  tags:
    - restic
    - restic.backup
