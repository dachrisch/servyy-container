---
# Setup local restic repository for testing on servyy-test.lxd
# This creates a local repository instead of using SFTP to storagebox

- name: Create local test restic repository directory
  file:
    path: /tmp/restic-test-repo
    state: directory
    owner: "{{ create_user }}"
    group: "{{ create_user }}"
    mode: '0755'
  become: true
  become_user: root
  tags:
    - restic.test

- name: Generate test restic password
  set_fact:
    restic_test_password: "static-test-password-servyy-test"
  tags:
    - restic.test

- name: Ensure /etc/restic directory exists
  file:
    path: /etc/restic
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: true
  become_user: root
  tags:
    - restic.test

- name: Check for existing test restic environment file
  stat:
    path: /etc/restic/env.test
  register: test_env_stat
  become: true
  become_user: root
  tags:
    - restic.test

- name: Slurp existing test restic environment file
  slurp:
    src: /etc/restic/env.test
  when: test_env_stat.stat.exists
  register: slurped_test_env
  become: true
  become_user: root
  tags:
    - restic.test

- name: Verify test restic password integrity
  fail:
    msg: |
      CRITICAL: Password mismatch for restic-test!
      The password in Ansible variables does NOT match the password currently on the host.
  vars:
    existing_content: "{{ slurped_test_env.content | b64decode }}"
    existing_pass: "{{ existing_content | regex_findall('export RESTIC_PASSWORD="(.*)"') | first | default('') }}"
  when:
    - test_env_stat.stat.exists
    - existing_pass != ""
    - existing_pass != restic_test_password
  tags:
    - restic.test

- name: Create test restic environment file
  copy:
    dest: /etc/restic/env.test
    content: |
      # Restic test environment configuration
      # Local repository for testing purposes only
      export RESTIC_REPOSITORY="/tmp/restic-test-repo"
      export RESTIC_PASSWORD="{{ restic_test_password }}"
      export RESTIC_CACHE_DIR="${HOME}/.cache/restic"
    mode: '0644'
    owner: root
    group: root
  become: true
  become_user: root
  tags:
    - restic.test

- name: Check if test repository is initialized
  stat:
    path: /tmp/restic-test-repo/config
  register: repo_config_stat
  tags:
    - restic.test

- name: Initialize test restic repository
  shell: |
    source /etc/restic/env.test
    restic init
  args:
    executable: /bin/bash
  become: true
  become_user: "{{ create_user }}"
  when: not repo_config_stat.stat.exists
  tags:
    - restic.test

- name: Create test backup script
  template:
    src: restic_test_backup.sh.j2
    dest: "{{ remote_user_home }}/.backup-scripts/restic-test-backup.sh"
    mode: '0750'
    owner: "{{ create_user }}"
    group: "{{ create_user }}"
  tags:
    - restic.test
