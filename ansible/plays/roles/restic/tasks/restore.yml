---
# Restic restore task with environment-aware error handling
# Supports both empty container bootstrap and incremental restore

- name: Check if restore target exists [{{ restore_path }}]
  stat:
    path: "{{ restore_path }}"
  register: target_stat
  tags:
    - restic.restore

- name: Check if target directory is empty
  find:
    paths: "{{ restore_path }}"
    recurse: no
  register: target_files
  when: target_stat.stat.exists and target_stat.stat.isdir
  tags:
    - restic.restore

- name: Check for existing snapshots in {{ backup_name }}
  shell: |
    if [ -f "/etc/restic/env.{{ backup_name }}" ]; then
        source "/etc/restic/env.{{ backup_name }}"
        restic snapshots --json 2>/dev/null || echo "[]"
    else
        echo "[]"
    fi
  args:
    executable: /bin/bash
  register: restic_snapshots_check
  become: true
  become_user: root
  changed_when: false
  failed_when: false
  tags:
    - restic.restore

- name: Set snapshot count fact
  set_fact:
    snapshot_count: "{{ restic_snapshots_check.stdout | default('[]') | from_json | length }}"
  tags:
    - restic.restore

- name: Set environment detection fact
  set_fact:
    is_test_environment: "{{ inventory_hostname == 'servyy-test.lxd' }}"
  tags:
    - restic.restore

# Environment-aware error handling for missing backups
- name: FAIL on test environment if no snapshots exist
  fail:
    msg: |
      RESTIC RESTORE FAILED: No snapshots found in repository '{{ backup_name }}'

      Path to restore: {{ restore_path }}
      Environment: TEST ({{ inventory_hostname }})

      This is expected to FAIL on test environments to catch backup issues early.
  when:
    - is_test_environment | bool
    - snapshot_count | int == 0
  tags:
    - restic.restore

- name: LOG warning on production if no snapshots exist
  debug:
    msg: |
      WARNING: No snapshots found in repository '{{ backup_name }}' for {{ restore_path }}

      Environment: PRODUCTION ({{ inventory_hostname }})
      Continuing deployment to allow fresh installations.
  when:
    - not (is_test_environment | bool)
    - snapshot_count | int == 0
  tags:
    - restic.restore

# ============================================================================
# PRE-RESTORE DECISION MATRIX
# ============================================================================

- name: Check if target directory is non-empty
  set_fact:
    target_is_empty: "{{ (not target_stat.stat.exists) or (target_files.matched | default(0) == 0) }}"
  tags:
    - restic.restore

- name: Check if Docker Compose service exists for this restore path
  stat:
    path: "{{ restore_path | dirname }}/docker-compose.yml"
  register: docker_compose_exists
  tags:
    - restic.restore

- name: Check if any containers are running for this service
  shell: |
    cd "{{ restore_path | dirname }}"
    if [ -f "docker-compose.yml" ]; then
      docker compose ps -q 2>/dev/null | wc -l
    else
      echo "0"
    fi
  register: running_containers_count
  when: docker_compose_exists.stat.exists
  changed_when: false
  become: true
  become_user: root
  failed_when: false
  tags:
    - restic.restore

- name: Set container running status
  set_fact:
    containers_running: "{{ docker_compose_exists.stat.exists and (running_containers_count.stdout | default('0') | int > 0) }}"
  tags:
    - restic.restore

- name: Determine if restore should proceed
  set_fact:
    should_restore: "{{ (snapshot_count | int > 0) and target_is_empty and not containers_running }}"
  tags:
    - restic.restore

- name: LOG skip reason - directory non-empty
  debug:
    msg: |
      ⏭️  SKIPPING RESTORE: Target directory is not empty
      Path: {{ restore_path }}
  when:
    - snapshot_count | int > 0
    - not target_is_empty
    - not containers_running
  tags:
    - restic.restore

- name: LOG skip reason - containers running
  debug:
    msg: |
      ⏭️  SKIPPING RESTORE: Service containers are running
      Path: {{ restore_path }}
  when:
    - snapshot_count | int > 0
    - containers_running
  tags:
    - restic.restore

# Create parent directory if it doesn't exist
- name: Create parent directory for restore path if missing
  file:
    path: "{{ restore_path }}"
    state: directory
    owner: "{{ owner | default(create_user) }}"
    group: "{{ group | default(owner) | default(create_user) }}"
    mode: '0755'
  become: true
  become_user: root
  when: not target_stat.stat.exists
  tags:
    - restic.restore

- name: Restore [{{ restore_path }}] from restic ({{ backup_name }})
  shell: |
    set -e
    source "/etc/restic/env.{{ backup_name }}"
    restic restore latest --target / --include "{{ restore_path }}"
  args:
    executable: /bin/bash
  become: true
  become_user: root
  register: restic_restored
  when: should_restore | bool
  tags:
    - restic.restore

- name: Display restore result
  debug:
    msg: |
      {% if restic_restored.changed %}
      ✅ RESTORED: {{ restore_path }}
      {% elif restic_restored.skipped %}
      ⏭️  SKIPPED: Restore not needed for {{ restore_path }}
      {% endif %}
  when: snapshot_count | int > 0
  tags:
    - restic.restore

- name: Ensure permissions on [{{ restore_path }}]
  file:
    path: "{{ restore_path }}"
    owner: "{{ owner | default(create_user) }}"
    group: "{{ group | default(owner) | default(create_user) }}"
    state: directory
    recurse: yes
  become: true
  become_user: root
  when: target_stat.stat.exists or (restic_restored.changed | default(false))
  tags:
    - restic.restore
    - restic.restore.permissions
