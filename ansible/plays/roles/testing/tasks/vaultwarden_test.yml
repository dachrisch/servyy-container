---
# Install and test Bitwarden CLI with Vaultwarden
# Tests password write/retrieve functionality using API key authentication

- name: Install unzip utility
  apt:
    name: unzip
    state: present
  tags:
    - testing.vaultwarden.install

- name: Install mkcert CA certificate in system trust store
  copy:
    src: "{{ mkcert.cert_dir }}/rootCA.pem"
    dest: /usr/local/share/ca-certificates/mkcert-ca.crt
    remote_src: yes
    mode: '0644'
  tags:
    - testing.vaultwarden.install

- name: Update CA certificates
  command: update-ca-certificates
  tags:
    - testing.vaultwarden.install

- name: Download Bitwarden CLI
  get_url:
    url: https://github.com/bitwarden/clients/releases/download/cli-v2024.12.0/bw-linux-2024.12.0.zip
    dest: /tmp/bw.zip
    mode: '0644'
  tags:
    - testing.vaultwarden.install

- name: Unzip Bitwarden CLI
  unarchive:
    src: /tmp/bw.zip
    dest: /usr/local/bin/
    remote_src: yes
  tags:
    - testing.vaultwarden.install

- name: Make bw executable
  file:
    path: /usr/local/bin/bw
    mode: '0755'
  tags:
    - testing.vaultwarden.install

- name: Set environment-specific variables
  set_fact:
    vw_config: "{{ vaultwarden.test if inventory_hostname_short == 'servyy-test' else vaultwarden.prod }}"
  tags:
    - testing.vaultwarden.test

- name: Logout from Bitwarden (if logged in)
  command: bw logout
  ignore_errors: yes
  tags:
    - testing.vaultwarden.test

- name: Configure Bitwarden server
  command: bw config server {{ vw_config.server_url }}
  tags:
    - testing.vaultwarden.test

- name: Login with API key
  shell: bw login --apikey
  environment:
    BW_CLIENTID: "{{ vw_config.api_client_id }}"
    BW_CLIENTSECRET: "{{ vw_config.api_client_secret }}"
    NODE_EXTRA_CA_CERTS: "{{ mkcert.cert_dir }}/rootCA.pem"
  no_log: true
  tags:
    - testing.vaultwarden.test

- name: Unlock vault and get session
  shell: bw unlock --passwordenv BW_PASSWORD --raw
  environment:
    NODE_EXTRA_CA_CERTS: "{{ mkcert.cert_dir }}/rootCA.pem"
    BW_PASSWORD: "{{ vw_config.master_password }}"
  no_log: true
  register: bw_session
  tags:
    - testing.vaultwarden.test

- name: Create test item
  shell: |
    ITEM_JSON='{{ item_json | to_json }}'
    echo "$ITEM_JSON" | bw encode | bw create item --session "{{ bw_session.stdout }}" | jq -r '.id' | tee /tmp/vaultwarden_test_item_id
  environment:
    NODE_EXTRA_CA_CERTS: "{{ mkcert.cert_dir }}/rootCA.pem"
  vars:
    item_json:
      type: 1
      name: "{{ vaultwarden.test_item_name }}"
      login:
        username: "{{ vaultwarden.test_username }}"
        password: "{{ vaultwarden.test_password }}"
  no_log: true
  register: create_result
  tags:
    - testing.vaultwarden.test

- name: Retrieve and verify test item
  shell: |
    ITEM_ID=$(cat /tmp/vaultwarden_test_item_id)
    RETRIEVED_PASSWORD=$(bw get item "$ITEM_ID" --session "{{ bw_session.stdout }}" | jq -r '.login.password')
    if [ "$RETRIEVED_PASSWORD" = "{{ vaultwarden.test_password }}" ]; then
      echo "✅ Password verification successful"
      exit 0
    else
      echo "❌ Password verification failed"
      exit 1
    fi
  environment:
    NODE_EXTRA_CA_CERTS: "{{ mkcert.cert_dir }}/rootCA.pem"
  no_log: true
  register: verify_result
  tags:
    - testing.vaultwarden.test

- name: Display test result
  debug:
    msg: "{{ verify_result.stdout }}"
  tags:
    - testing.vaultwarden.test

- name: Cleanup test item
  shell: |
    ITEM_ID=$(cat /tmp/vaultwarden_test_item_id)
    bw delete item "$ITEM_ID" --session "{{ bw_session.stdout }}"
    rm /tmp/vaultwarden_test_item_id
  environment:
    NODE_EXTRA_CA_CERTS: "{{ mkcert.cert_dir }}/rootCA.pem"
  no_log: true
  ignore_errors: yes
  tags:
    - testing.vaultwarden.cleanup
