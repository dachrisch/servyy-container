---
# Install and configure mkcert for local certificate authority
# Only runs on servyy-test.lxd (test environment)

- name: Install mkcert via apt
  apt:
    name: mkcert
    state: present
  tags:
    - testing.mkcert.install

- name: Create certificate directory
  file:
    path: "{{ mkcert.cert_dir }}"
    state: directory
    mode: '0755'
    owner: root
    group: root
  tags:
    - testing.mkcert.install

- name: Create local CA
  shell: "mkcert -install"
  environment:
    CAROOT: "{{ mkcert.cert_dir }}"
  args:
    creates: "{{ mkcert.cert_dir }}/rootCA.pem"
  tags:
    - testing.mkcert.ca

- name: Generate wildcard certificate for servyy-test.lxd
  shell: |
    mkcert \
      -cert-file {{ mkcert.cert_dir }}/servyy-test.crt \
      -key-file {{ mkcert.cert_dir }}/servyy-test.key \
      {% for domain in mkcert.domains %}
      "{{ domain }}" \
      {% endfor %}
  environment:
    CAROOT: "{{ mkcert.cert_dir }}"
  args:
    creates: "{{ mkcert.cert_dir }}/servyy-test.crt"
  tags:
    - testing.mkcert.certificates

- name: Set certificate file permissions
  file:
    path: "{{ item.path }}"
    mode: "{{ item.mode }}"
    owner: root
    group: root
  loop:
    - {path: "{{ mkcert.cert_dir }}/servyy-test.crt", mode: '0644'}
    - {path: "{{ mkcert.cert_dir }}/servyy-test.key", mode: '0600'}
    - {path: "{{ mkcert.cert_dir }}/rootCA.pem", mode: '0644'}
    - {path: "{{ mkcert.cert_dir }}/rootCA-key.pem", mode: '0600'}
  tags:
    - testing.mkcert.permissions

- name: Append mkcert certificate configuration to Traefik dynamic.yaml
  blockinfile:
    path: "{{ (docker.remote_dir, 'traefik', 'dynamic.yaml') | path_join }}"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - mkcert certificates"
    block: |
      # mkcert certificates for servyy-test.lxd (test environment only)
      tls:
        certificates:
          - certFile: {{ mkcert.cert_dir }}/servyy-test.crt
            keyFile: {{ mkcert.cert_dir }}/servyy-test.key
            # Used for all *.servyy-test.lxd domains
    mode: '0644'
    create: no
    insertafter: EOF
  notify: restart traefik
  when: lookup('env', 'MOLECULE_SCENARIO_NAME') == ''  # Skip in Molecule tests
  tags:
    - testing.mkcert.traefik
    - molecule-notest

- name: Add mkcert volume mount to Traefik docker-compose.yml
  blockinfile:
    path: "{{ (docker.remote_dir, 'traefik', 'docker-compose.yml') | path_join }}"
    marker: "      # {mark} ANSIBLE MANAGED BLOCK - mkcert volumes"
    insertafter: "^\\s+volumes:"
    block: "      # mkcert certificate directory (test environment only)\n      - /etc/ssl/mkcert:/etc/ssl/mkcert:ro"
    create: no
  notify: restart traefik
  when: lookup('env', 'MOLECULE_SCENARIO_NAME') == ''  # Skip in Molecule tests
  tags:
    - testing.mkcert.traefik
    - molecule-notest

- name: Deploy mkcert README
  template:
    src: mkcert/README-mkcert.md.j2
    dest: "{{ (docker.remote_dir, 'traefik', 'README-mkcert.md') | path_join }}"
    mode: '0644'
    force: no
  when: lookup('env', 'MOLECULE_SCENARIO_NAME') == ''  # Skip in Molecule tests
  tags:
    - testing.mkcert.documentation
    - molecule-notest

- name: Fetch CA certificate to local machine
  fetch:
    src: "{{ mkcert.cert_dir }}/rootCA.pem"
    dest: /tmp/servyy-test-ca.pem
    flat: yes
  tags:
    - testing.mkcert.local
    - molecule-notest

- name: Install CA certificate on local machine (macOS)
  shell: |
    sudo security add-trusted-cert -d -r trustRoot \
      -k /Library/Keychains/System.keychain \
      /tmp/servyy-test-ca.pem
  delegate_to: localhost
  become: false
  when: ansible_facts['os_family'] == "Darwin"
  args:
    creates: "/tmp/servyy-test-ca.installed"  # Simple marker file or specific cert check
  ignore_errors: yes
  tags:
    - testing.mkcert.local
    - molecule-notest

- name: Install CA certificate on local machine (Linux)
  shell: |
    if [ ! -f /usr/local/share/ca-certificates/servyy-test-ca.crt ]; then
      sudo cp /tmp/servyy-test-ca.pem /usr/local/share/ca-certificates/servyy-test-ca.crt
      sudo update-ca-certificates
      echo "changed"
    fi
  delegate_to: localhost
  become: false
  register: linux_ca_install
  changed_when: "'changed' in linux_ca_install.stdout"
  when: ansible_facts['os_family'] != "Darwin"
  ignore_errors: yes
  tags:
    - testing.mkcert.local
    - molecule-notest
