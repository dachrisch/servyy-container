---
# Test Vaultwarden organization API with direct REST calls
#
# FINDINGS:
# - Organization API keys CAN authenticate and get OAuth tokens WITHOUT master password
# - Organization API keys CANNOT access user vault endpoints (/api/ciphers, /api/accounts/profile)
# - Organization API keys are intended for organization management (collections, groups, members)
# - For password write/retrieve automation, use USER API key (requires master password)
#
# This test demonstrates the limitations of organization API keys for vault item access

- name: Set environment-specific variables for org API
  set_fact:
    vw_config: "{{ vaultwarden.test if inventory_hostname_short == 'servyy-test' else vaultwarden.prod }}"
  tags:
    - testing.vaultwarden.org_api

- name: Get OAuth token with organization credentials
  uri:
    url: "{{ vw_config.server_url }}/identity/connect/token"
    method: POST
    body_format: form-urlencoded
    body:
      grant_type: client_credentials
      scope: api.organization
      client_id: "{{ vw_config.org_api_client_id }}"
      client_secret: "{{ vw_config.org_api_client_secret }}"
      device_identifier: "ansible-test-{{ inventory_hostname_short }}"
      device_type: "10"
      device_name: "Ansible Testing"
    validate_certs: false
    return_content: yes
  register: oauth_response
  no_log: true
  tags:
    - testing.vaultwarden.org_api

- name: Display OAuth token info (without sensitive data)
  debug:
    msg: "Token type: {{ oauth_response.json.token_type | default('N/A') }}, Expires in: {{ oauth_response.json.expires_in | default('N/A') }}s, Has token: {{ (oauth_response.json.access_token | default('') | length > 0) | string }}"
  tags:
    - testing.vaultwarden.org_api

- name: Try to list ciphers with organization token
  uri:
    url: "{{ vw_config.server_url }}/api/ciphers"
    method: GET
    headers:
      Authorization: "Bearer {{ oauth_response.json.access_token }}"
    validate_certs: false
    return_content: yes
    status_code: [200, 401, 403]
  register: list_response
  no_log: false
  tags:
    - testing.vaultwarden.org_api

- name: Display list response
  debug:
    msg: "Status: {{ list_response.status }}, Response: {{ list_response.json | default(list_response.content) }}"
  tags:
    - testing.vaultwarden.org_api

- name: Try to access user profile endpoint
  uri:
    url: "{{ vw_config.server_url }}/api/accounts/profile"
    method: GET
    headers:
      Authorization: "Bearer {{ oauth_response.json.access_token }}"
    validate_certs: false
    return_content: yes
    status_code: [200, 401, 403]
  register: profile_response
  no_log: false
  tags:
    - testing.vaultwarden.org_api

- name: Display profile response
  debug:
    msg: "Status: {{ profile_response.status }}, Has profile: {{ (profile_response.json.Id | default('') | length > 0) | string }}"
  tags:
    - testing.vaultwarden.org_api

- name: Try to create cipher with organization token
  uri:
    url: "{{ vw_config.server_url }}/api/ciphers"
    method: POST
    headers:
      Authorization: "Bearer {{ oauth_response.json.access_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      type: 1
      name: "{{ vaultwarden.test_item_name }}-org-api"
      login:
        username: "{{ vaultwarden.test_username }}"
        password: "{{ vaultwarden.test_password }}"
    validate_certs: false
    return_content: yes
    status_code: [200, 201, 400, 401, 403]
  register: create_response
  no_log: false
  tags:
    - testing.vaultwarden.org_api

- name: Display create response
  debug:
    msg: "Status: {{ create_response.status }}, Has ID: {{ (create_response.json.id | default('') | length > 0) | string }}, Response: {{ create_response.json | default(create_response.content) }}"
  tags:
    - testing.vaultwarden.org_api

- name: Retrieve created cipher if successful
  uri:
    url: "{{ vw_config.server_url }}/api/ciphers/{{ create_response.json.id }}"
    method: GET
    headers:
      Authorization: "Bearer {{ oauth_response.json.access_token }}"
    validate_certs: false
    return_content: yes
    status_code: [200, 401, 403, 404]
  register: retrieve_response
  when: create_response.status in [200, 201] and create_response.json.id is defined
  no_log: true
  tags:
    - testing.vaultwarden.org_api

- name: Verify retrieved password
  debug:
    msg: "âœ… Organization API test successful - Password verified!"
  when:
    - create_response.status in [200, 201]
    - retrieve_response.json.login.password == vaultwarden.test_password
  tags:
    - testing.vaultwarden.org_api

- name: Cleanup test cipher
  uri:
    url: "{{ vw_config.server_url }}/api/ciphers/{{ create_response.json.id }}"
    method: DELETE
    headers:
      Authorization: "Bearer {{ oauth_response.json.access_token }}"
    validate_certs: false
    status_code: [200, 204, 404]
  when: create_response.status in [200, 201] and create_response.json.id is defined
  ignore_errors: yes
  tags:
    - testing.vaultwarden.org_api.cleanup
