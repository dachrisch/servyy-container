---
- name: Verify (Testing)
  hosts: all
  become: true
  tasks:
    # Note: resolve tasks modify Ansible controller's /etc/hosts (delegate_to: localhost),
    # not the instance's /etc/hosts, so we can't verify hosts entries here.
    # The converge success already confirms resolve tasks ran correctly.

    - name: Check runc package status
      command: dpkg-query -W -f='${Status}' runc
      register: runc_status
      changed_when: false

    - name: Verify runc is held (if version < safe version)
      assert:
        that:
          - "'hold' in runc_status.stdout or 'install ok installed' in runc_status.stdout"
        fail_msg: "runc package status is not as expected"

    - name: Check if mkcert is installed
      command: which mkcert
      register: mkcert_check
      changed_when: false
      failed_when: mkcert_check.rc != 0

    - name: Verify mkcert binary exists
      stat:
        path: /usr/local/bin/mkcert
      register: mkcert_bin

    - name: Assert mkcert is installed
      assert:
        that:
          - mkcert_bin.stat.exists
          - mkcert_bin.stat.executable
        fail_msg: "mkcert not properly installed"

    - name: Check if mkcert cert directory exists
      stat:
        path: /etc/ssl/mkcert
      register: mkcert_dir

    - name: Verify mkcert directory was created
      assert:
        that:
          - mkcert_dir.stat.exists
          - mkcert_dir.stat.isdir
        fail_msg: "mkcert cert directory not found"
