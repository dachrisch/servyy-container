---
- name: Create restic log directory
  file:
    path: "{{ restic.log_dir }}"
    state: directory
    owner: "{{ create_user }}"
    group: "{{ create_user }}"
    mode: '0755'
  become: true
  become_user: root
  tags:
    - user.restic.init

- name: Create restic config directory (system-wide)
  file:
    path: /etc/restic
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: true
  become_user: root
  tags:
    - user.restic.init

- name: Deploy restic environment files (system-wide)
  template:
    src: restic_env.j2
    dest: "/etc/restic/env.{{ item.name }}"
    owner: root
    group: root
    mode: '0644'
  vars:
    env_name: "{{ item.env_name }}"
    repository: "{{ item.repository }}"
    password: "{{ item.password }}"
  loop:
    - name: home
      repository: "{{ restic.home.repository }}"
      password: "{{ restic.home.password }}"
      env_name: "home"
    - name: root
      repository: "{{ restic.root.repository }}"
      password: "{{ restic.root.password }}"
      env_name: "root"
  register: restic_env_files
  become: true
  become_user: root
  tags:
    - user.restic.init

- name: Create restic config directory for user
  file:
    path: "{{ remote_user_home }}/.config/restic"
    state: directory
    owner: "{{ create_user }}"
    group: "{{ create_user }}"
    mode: '0700'
  tags:
    - user.restic.init

- name: Create default restic environment for user (symlink to home)
  file:
    src: /etc/restic/env.home
    dest: "{{ remote_user_home }}/.config/restic/env"
    state: link
  tags:
    - user.restic.init

- name: Create restic config directory for root
  file:
    path: /root/.config/restic
    state: directory
    owner: root
    group: root
    mode: '0700'
  become: true
  become_user: root
  tags:
    - user.restic.init

- name: Create default restic environment for root (symlink to root repo)
  file:
    src: /etc/restic/env.root
    dest: /root/.config/restic/env
    state: link
  become: true
  become_user: root
  tags:
    - user.restic.init

- name: Ensure .ssh directory exists
  file:
    path: "{{ remote_user_home }}/.ssh"
    state: directory
    owner: "{{ create_user }}"
    group: "{{ create_user }}"
    mode: '0700'
  tags:
    - user.restic.init

- name: Copy Storage Box SSH private key to server
  copy:
    src: ~/.ssh/id_storagebox
    dest: "{{ remote_user_home }}/.ssh/id_storagebox"
    owner: "{{ create_user }}"
    group: "{{ create_user }}"
    mode: '0600'
  when: not (skip_storagebox | default(false))
  tags:
    - user.restic.init

- name: Copy Storage Box SSH public key to server
  copy:
    src: ~/.ssh/id_storagebox.pub
    dest: "{{ remote_user_home }}/.ssh/id_storagebox.pub"
    owner: "{{ create_user }}"
    group: "{{ create_user }}"
    mode: '0644'
  when: not (skip_storagebox | default(false))
  tags:
    - user.restic.init

- name: Deploy SSH config for Storage Box
  template:
    src: ssh_config_storagebox.j2
    dest: "{{ remote_user_home }}/.ssh/config"
    owner: "{{ create_user }}"
    group: "{{ create_user }}"
    mode: '0600'
  when: not (skip_storagebox | default(false))
  tags:
    - user.restic.init

- name: Add Storage Box to known_hosts
  shell: |
    if ! ssh-keygen -F "[{{ restic.sftp.hostname }}]:{{ restic.sftp.port }}" -f {{ remote_user_home }}/.ssh/known_hosts >/dev/null 2>&1; then
      ssh-keyscan -p {{ restic.sftp.port }} {{ restic.sftp.hostname }} >> {{ remote_user_home }}/.ssh/known_hosts
    fi
  args:
    executable: /bin/bash
  register: ssh_keyscan
  changed_when: "'added' in ssh_keyscan.stdout or ssh_keyscan.rc == 0"
  failed_when: false
  when: not (skip_storagebox | default(false))
  tags:
    - user.restic.init

- name: Create restic repository directories on Storage Box
  shell: |
    sftp {{ restic.sftp.host_alias }} <<'EOF' 2>&1
    -mkdir {{ storagebox_credentials.share }}/{{ inventory_hostname }}/restic-home
    -mkdir {{ storagebox_credentials.share }}/{{ inventory_hostname }}/restic-root
    EOF
  register: sftp_mkdir
  failed_when: false
  changed_when: "'Failure' not in sftp_mkdir.stdout and 'File exists' not in sftp_mkdir.stdout"
  when: not (skip_storagebox | default(false))
  tags:
    - user.restic.init

- name: Initialize restic repositories
  shell: |
    export RESTIC_REPOSITORY="{{ item.repository }}"
    export RESTIC_PASSWORD="{{ item.password }}"
    if ! restic snapshots >/dev/null 2>&1; then
      restic init
    else
      echo "repository already initialized"
    fi
  loop:
    - "{{ restic.home }}"
    - "{{ restic.root }}"
  register: restic_init
  when: (restic_env_files.changed or (not (skip_storagebox | default(false)) and sftp_mkdir.changed)) or (skip_storagebox | default(false))
  changed_when: "'created restic repository' in restic_init.stdout"
  failed_when: false
  tags:
    - user.restic.init

- name: Create restic log files with correct permissions
  file:
    path: "{{ item }}"
    state: touch
    owner: "{{ create_user }}"
    group: "{{ create_user }}"
    mode: '0644'
    modification_time: preserve
    access_time: preserve
  loop: "{{ restic.logs | dict2items | map(attribute='value') | list }}"
  become: true
  become_user: root
  tags:
    - user.restic.init

# Root user SSH setup for sudo restic operations
- name: Ensure root .ssh directory exists
  file:
    path: /root/.ssh
    state: directory
    owner: root
    group: root
    mode: '0700'
  become: true
  become_user: root
  when: not (skip_storagebox | default(false))
  tags:
    - user.restic.init

- name: Copy Storage Box SSH keys to root
  copy:
    src: "{{ remote_user_home }}/.ssh/{{ item }}"
    dest: "/root/.ssh/{{ item }}"
    owner: root
    group: root
    mode: "{{ '0600' if 'id_storagebox' == item else '0644' }}"
    remote_src: true
  loop:
    - id_storagebox
    - id_storagebox.pub
  become: true
  become_user: root
  when: not (skip_storagebox | default(false))
  tags:
    - user.restic.init

- name: Deploy SSH config for Storage Box (root)
  template:
    src: ssh_config_storagebox_root.j2
    dest: /root/.ssh/config
    owner: root
    group: root
    mode: '0600'
  become: true
  become_user: root
  when: not (skip_storagebox | default(false))
  tags:
    - user.restic.init

- name: Add Storage Box to known_hosts (root)
  shell: |
    if ! ssh-keygen -F "[{{ restic.sftp.hostname }}]:{{ restic.sftp.port }}" -f /root/.ssh/known_hosts >/dev/null 2>&1; then
      ssh-keyscan -p {{ restic.sftp.port }} {{ restic.sftp.hostname }} >> /root/.ssh/known_hosts
    fi
  args:
    executable: /bin/bash
  register: ssh_keyscan_root
  changed_when: "'added' in ssh_keyscan_root.stdout or ssh_keyscan_root.rc == 0"
  failed_when: false
  become: true
  become_user: root
  when: not (skip_storagebox | default(false))
  tags:
    - user.restic.init
