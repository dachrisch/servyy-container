---
# Setup local restic repository for testing on servyy-test.lxd
# This creates a local repository instead of using SFTP to storagebox

- name: Create local test restic repository directory
  file:
    path: /tmp/restic-test-repo
    state: directory
    owner: "{{ create_user }}"
    group: "{{ create_user }}"
    mode: '0755'
  become: true

- name: Generate test restic password
  set_fact:
    restic_test_password: "static-test-password-servyy-test"

- name: Ensure /etc/restic directory exists
  file:
    path: /etc/restic
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: true

- name: Create test restic environment file
  copy:
    dest: /etc/restic/env.test
    content: |
      # Restic test environment configuration
      # Local repository for testing purposes only
      export RESTIC_REPOSITORY="/tmp/restic-test-repo"
      export RESTIC_PASSWORD="{{ restic_test_password }}"
      export RESTIC_CACHE_DIR="${HOME}/.cache/restic"
    mode: '0644'
    owner: root
    group: root
  become: true
  become_user: root

- name: Check if test repository is initialized
  stat:
    path: /tmp/restic-test-repo/config
  register: repo_config_stat

- name: Initialize test restic repository
  shell: |
    source /etc/restic/env.test
    restic init
  args:
    executable: /bin/bash
  become: true
  become_user: "{{ create_user }}"
  when: not repo_config_stat.stat.exists

- name: Create test backup script
  template:
    src: restic_test_backup.sh.j2
    dest: "{{ remote_user_home }}/.backup-scripts/restic-test-backup.sh"
    mode: '0750'
    owner: "{{ create_user }}"
    group: "{{ create_user }}"

- name: Display test restic status
  debug:
    msg: |
      Test restic repository configured:
      - Repository: /tmp/restic-test-repo
      - Environment: /etc/restic/env.test
      - Backup script: {{ remote_user_home }}/.backup-scripts/restic-test-backup.sh

      To create a test backup:
      ssh {{ inventory_hostname }} "{{ remote_user_home }}/.backup-scripts/restic-test-backup.sh"

      To list snapshots:
      ssh {{ inventory_hostname }} "source /etc/restic/env.test && restic snapshots"
