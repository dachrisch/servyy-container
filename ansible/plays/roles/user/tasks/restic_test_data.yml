---
# Create test data for restic restore testing
# Only runs on servyy-test.lxd

- name: Ensure service directories exist with correct ownership
  file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: '0755'
  become: true
  become_user: root
  loop:
    - path: /home/{{ create_user }}/servyy-container/git/repos
      owner: root
      group: root
    - path: /home/{{ create_user }}/servyy-container/photoprism/database
      owner: "{{ create_user }}"
      group: "{{ create_user }}"
    - path: /home/{{ create_user }}/servyy-container/pass/vw-data
      owner: root
      group: root

- name: Create test files in git/repos
  copy:
    dest: /home/{{ create_user }}/servyy-container/git/repos/{{ item.name }}
    content: "{{ item.content }}"
    owner: root
    group: root
    mode: '0644'
  become: true
  become_user: root
  loop:
    - name: test-repo-1.txt
      content: |
        Test repository file 1
        Created: {{ ansible_facts['date_time']['iso8601'] }}
        This file tests git restore functionality
    - name: test-repo-2.txt
      content: |
        Test repository file 2
        This simulates a git repository
    - name: README.md
      content: |
        # Test Git Repository
        This is test data for restic restore validation

- name: Create test files in photoprism/database
  copy:
    dest: /home/{{ create_user }}/servyy-container/photoprism/database/{{ item.name }}
    content: "{{ item.content }}"
    owner: "{{ create_user }}"
    group: "{{ create_user }}"
    mode: '0644'
  become: true
  become_user: root
  loop:
    - name: test-db.sql
      content: |
        -- Test database file
        -- Created: {{ ansible_facts['date_time']['iso8601'] }}
        CREATE TABLE test (id INT, name VARCHAR(50));
    - name: photoprism.db
      content: |
        Simulated PhotoPrism database file
        Size: 1KB test data
    - name: backup-info.txt
      content: |
        Database backup created for testing
        Timestamp: {{ ansible_facts['date_time']['iso8601'] }}

- name: Create test files in pass/vw-data
  copy:
    dest: /home/{{ create_user }}/servyy-container/pass/vw-data/{{ item.name }}
    content: "{{ item.content }}"
    owner: root
    group: root
    mode: '0644'
  become: true
  become_user: root
  loop:
    - name: test-vault.db
      content: |
        Test Vaultwarden database
        Created: {{ ansible_facts['date_time']['iso8601'] }}
    - name: config.json
      content: |
        {
          "test": true,
          "created": "{{ ansible_facts['date_time']['iso8601'] }}"
        }

- name: Display test data summary
  debug:
    msg: |
      Test data created successfully:
      - git/repos: 3 files
      - photoprism/database: 3 files
      - pass/vw-data: 2 files

      Next steps:
      1. Run backup: ssh {{ inventory_hostname }} "{{ remote_user_home }}/.backup-scripts/restic-test-backup.sh"
      2. Wipe directories
      3. Test restore
