# Docker Setup
# Docker packages (docker.io, docker-compose-v2, docker-buildx) are installed
# via sys_packages in system.yml for simplicity and Ubuntu compatibility

- name: Remove ancient docker compose
  apt: name=docker-compose state=absent
  become_user: root
  tags:
    - user.docker.install

- name: Check if docker group exists
  getent:
    database: group
    key: docker
  register: docker_group_check
  failed_when: false
  tags:
    - user.docker.install.add_group

- name: adding existing user '{{ create_user }}' to group docker
  user:
    name: '{{ create_user }}'
    groups: docker
    append: yes
  become_user: root
  register: group_added
  when: docker_group_check.ansible_facts.getent_group.docker is defined
  tags:
    - user.docker.install.add_group

- name: Reboot to apply changes
  reboot:
    msg: Reboot to make docker user available
  become_user: root
  when:
    - group_added.changed
    - ansible_virtualization_type | default('') != 'docker'
  tags:
    - user.docker.install.reboot

- name: Create external network
  docker_network:
    name: proxy
  tags:
    - user.docker.create.network
    - molecule-notest  # Requires Docker daemon access

# https://stackoverflow.com/questions/43689271/wheres-dockers-daemon-json-missing
- name: Configure docker daemon logging
  become_user: root
  json_patch:
    src: '/etc/docker/daemon.json'
    create: true
    operations:
      - op: add
        path: 'log-driver'
        value: 'local'
  tags:
    - molecule-notest  # Requires Docker to be installed

- name: Check if mount point "{{ extension_drive.path }}" exists
  stat:
    path: "{{ extension_drive.path }}"
  register: root_added

- block:
    - name: Configure docker daemon data root
      become_user: root
      json_patch:
        src: '/etc/docker/daemon.json'
        create: true
        pretty: true
        operations:
          - op: add
            path: 'data-root'
            value: "{{ extension_drive.path }}/docker"
      register: root_added_config

    - name: Restart Docker to apply changes
      service:
        name: docker
        state: restarted
      when: (root_added_config.changed | default(false))
  when: root_added.stat.exists
  tags:
    - molecule-notest  # Requires Docker to be installed and mount point
