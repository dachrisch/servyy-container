---
local_user: "{{ lookup('env', 'USER') }}"
remote_user_home: "{{ ('/home/', create_user) | path_join }}"
remote_user_systemd: "{{ (remote_user_home, '.config/systemd/user') | path_join }}"
copy_local_key: "{{ lookup('file', lookup('env','HOME') + '/.ssh/id_rsa.pub') }}"
sys_packages:
  - monit                       # server monitoring
  - jq                          # json parsing
  - curl
  - vim
  - git
  - zsh                         # default shell
  - cifs-utils                  # storagebox
  - git-crypt                   # encrypt files in git
  - locales                     # language options
  - linux-image-generic         # image + extras
  - btop                        # better top
  - binutils                    # ar
  - docker.io                   # docker engine
  - docker-compose-v2           # docker compose plugin
  - docker-buildx               # docker buildx plugin
  - restic                      # backup tool with deduplication
  - sshpass                     # SFTP authentication for restic

swap_space: 2G

storagebox:
  file: /etc/storagebox.cred
  mount: /mnt/storagebox
  remote: "//{{storagebox_credentials.host}}/{{storagebox_credentials.share}}"
  fstype: cifs

backup_dir: "{{(storagebox.mount, 'backup', inventory_hostname) | path_join}}"

extension_drive:
  path: /mnt/10g_volume
  device: /dev/disk/by-id/scsi-0HC_Volume_101343964
  fstype: ext4
  opts: discard,defaults

# Journal log retention (declarative)
journald:
  system_max_use: 500M
  max_retention_sec: 4week
  max_file_size: 100M

# Docker cleanup (aggressive, weekly)
docker_cleanup:
  enabled: true
  schedule: 'Sun 02:00'  # After PhotoPrism backup, before home backup
  log_file: '/var/log/docker-cleanup.log'
  prune_flags: '-a -f --volumes'  # Aggressive: all unused images + volumes

# runc LXC fix (CVE-2025-52881 workaround)
# runc 1.3.3 breaks Docker in LXC containers; auto-unhold when this version is available
runc_safe_version: "1.4.0"

# Kernel cleanup (monthly)
kernel_cleanup:
  enabled: true
  schedule: 'Sun *-*-1..7 01:00'  # 1st Sunday of month, 01:00 UTC
  script_path: '/usr/local/bin/kernel-cleanup.sh'
  log_file: '/var/log/kernel-cleanup.log'
  description: 'Remove old kernel packages'

# mkcert - Local CA for test environments
mkcert:
  cert_dir: /etc/ssl/mkcert
  domains:
    - "servyy-test.lxd"
    - "*.servyy-test.lxd"
    - "localhost"
    - "127.0.0.1"
    - "::1"
