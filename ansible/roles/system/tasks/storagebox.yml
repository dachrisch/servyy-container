# Mount storgabox
- name: Create credential file (used for fstab entry)
  copy:
    content: |
      username={{ storagebox_credentials.user }}
      password={{ storagebox_credentials.password }}
    dest: "{{ storagebox.file }}"
    mode: 0600
  tags:
    - system.storagebox.credentials

- name: Check mountpoint exist
  file:
    path: "{{ storagebox.mount }}"
    state: directory
    owner: "{{ create_user }}"
    group: "{{ create_user }}"
    mode: "0755"
  tags:
    - system.storagebox.mount.exist

# XXX: first time fails
- name: Create fstab entry for folder share
  mount:
    state: present
    fstype: cifs
    opts: "credentials={{ storagebox.file }},iocharset=utf8,uid=1000,gid=1000"
    src: "{{ storagebox_credentials.remote }}"
    path: "{{ storagebox.mount }}"
  tags:
    - system.storagebox.mount.fstab

- name: Check if storagebox is already mounted
  command: '/bin/mountpoint -q {{storagebox.mount}}'
  register: storagebox_mount
  ignore_errors: yes
  changed_when: "storagebox_mount.rc != 0"
  tags:
    - system.storagebox.mount.check

- name: Mount storagebox
  command: mount "{{ storagebox.mount }}"
  when: storagebox_mount.changed
  tags:
    - system.storagebox.mount
